{"timestamp": "2025-01-02T04:48:29.074053", "level": "WARNING", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "verify_token", "line": 364, "message": "Token expired"}
{"timestamp": "2025-01-02T04:48:53.464372", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 531, "message": "Unexpected authentication error: Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands."}
{"timestamp": "2025-01-02T04:52:36.811723", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 531, "message": "Unexpected authentication error: Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands."}
{"timestamp": "2025-01-02T05:01:16.103800", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 542, "message": "Unexpected authentication error"}
{"timestamp": "2025-01-02T05:03:49.395982", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 542, "message": "Unexpected authentication error"}
{"timestamp": "2025-01-02T05:11:10.563846", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "record_failed_attempt", "line": 287, "message": "Error recording failed attempt: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.NotNullViolationError'>: null value in column \"school_id\" of relation \"failed_login_attempts\" violates not-null constraint\nDETAIL:  Failing row contains (13, null, 2025-01-01 21:11:10.434245-08, 127.0.0.1, null, mikailismai260@gmail.com).\n[SQL: INSERT INTO failed_login_attempts (email, timestamp, ip_address, user_id, school_id) VALUES ($1::VARCHAR, $2::TIMESTAMP WITH TIME ZONE, $3::VARCHAR, $4::INTEGER, $5::INTEGER) RETURNING failed_login_attempts.id]\n[parameters: ('mikailismai260@gmail.com', datetime.datetime(2025, 1, 2, 5, 11, 10, 434245, tzinfo=datetime.timezone.utc), '127.0.0.1', None, None)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-01-02T05:11:10.589267", "level": "WARNING", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 533, "message": "Authentication failed"}
{"timestamp": "2025-01-02T05:13:48.410183", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "record_failed_attempt", "line": 287, "message": "Error recording failed attempt: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.NotNullViolationError'>: null value in column \"school_id\" of relation \"failed_login_attempts\" violates not-null constraint\nDETAIL:  Failing row contains (14, null, 2025-01-01 21:13:48.383433-08, 127.0.0.1, null, mikailismai260@gmail.com).\n[SQL: INSERT INTO failed_login_attempts (email, timestamp, ip_address, user_id, school_id) VALUES ($1::VARCHAR, $2::TIMESTAMP WITH TIME ZONE, $3::VARCHAR, $4::INTEGER, $5::INTEGER) RETURNING failed_login_attempts.id]\n[parameters: ('mikailismai260@gmail.com', datetime.datetime(2025, 1, 2, 5, 13, 48, 383433, tzinfo=datetime.timezone.utc), '127.0.0.1', None, None)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-01-02T05:13:48.419509", "level": "WARNING", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 533, "message": "Authentication failed"}
{"timestamp": "2025-01-02T05:14:31.272382", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "record_failed_attempt", "line": 287, "message": "Error recording failed attempt: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.NotNullViolationError'>: null value in column \"school_id\" of relation \"failed_login_attempts\" violates not-null constraint\nDETAIL:  Failing row contains (15, null, 2025-01-01 21:14:31.258822-08, 127.0.0.1, null, mikailismai260@gmail.com).\n[SQL: INSERT INTO failed_login_attempts (email, timestamp, ip_address, user_id, school_id) VALUES ($1::VARCHAR, $2::TIMESTAMP WITH TIME ZONE, $3::VARCHAR, $4::INTEGER, $5::INTEGER) RETURNING failed_login_attempts.id]\n[parameters: ('mikailismai260@gmail.com', datetime.datetime(2025, 1, 2, 5, 14, 31, 258822, tzinfo=datetime.timezone.utc), '127.0.0.1', None, None)]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-01-02T05:14:31.274358", "level": "WARNING", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 533, "message": "Authentication failed"}
{"timestamp": "2025-01-02T05:14:46.802385", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 542, "message": "Unexpected authentication error"}
{"timestamp": "2025-01-02T05:25:18.471944", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 543, "message": "Unexpected authentication error"}
{"timestamp": "2025-01-02T05:30:18.901715", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 543, "message": "Unexpected authentication error", "exception": {"type": "InvalidRequestError", "message": "Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands.", "traceback": ["Traceback (most recent call last):\n", "  File \"/root/projects/school-attendance-management-software/app/services/auth_service.py\", line 498, in authenticate_user\n    sub=str(user.id),\n            ^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py\", line 566, in __get__\n    return self.impl.get(state, dict_)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py\", line 1086, in get\n    value = self._fire_loader_callables(state, key, passive)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py\", line 1116, in _fire_loader_callables\n    return state._load_expired(state, passive)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py\", line 803, in _load_expired\n    self.manager.expired_attribute_loader(self, toload, passive)\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py\", line 1670, in load_scalar_attributes\n    result = load_on_ident(\n             ^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py\", line 509, in load_on_ident\n    return load_on_pk_identity(\n           ^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py\", line 694, in load_on_pk_identity\n    session.execute(\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2362, in execute\n    return self._execute_internal(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2237, in _execute_internal\n    conn = self._connection_for_bind(bind)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2101, in _connection_for_bind\n    TransactionalContext._trans_ctx_check(self)\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/engine/util.py\", line 111, in _trans_ctx_check\n    raise exc.InvalidRequestError(\n", "sqlalchemy.exc.InvalidRequestError: Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands.\n"]}}
{"timestamp": "2025-01-02T05:32:39.762826", "level": "ERROR", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 552, "message": "Unexpected authentication error", "exception": {"type": "InvalidRequestError", "message": "Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands.", "traceback": ["Traceback (most recent call last):\n", "  File \"/root/projects/school-attendance-management-software/app/services/auth_service.py\", line 508, in authenticate_user\n    user_id=user.id  # This should be safe as it's already loaded\n            ^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py\", line 566, in __get__\n    return self.impl.get(state, dict_)  # type: ignore[no-any-return]\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py\", line 1086, in get\n    value = self._fire_loader_callables(state, key, passive)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/attributes.py\", line 1116, in _fire_loader_callables\n    return state._load_expired(state, passive)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py\", line 803, in _load_expired\n    self.manager.expired_attribute_loader(self, toload, passive)\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py\", line 1670, in load_scalar_attributes\n    result = load_on_ident(\n             ^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py\", line 509, in load_on_ident\n    return load_on_pk_identity(\n           ^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py\", line 694, in load_on_pk_identity\n    session.execute(\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2362, in execute\n    return self._execute_internal(\n           ^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2237, in _execute_internal\n    conn = self._connection_for_bind(bind)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py\", line 2101, in _connection_for_bind\n    TransactionalContext._trans_ctx_check(self)\n", "  File \"/root/projects/school-attendance-management-software/venv/lib/python3.12/site-packages/sqlalchemy/engine/util.py\", line 111, in _trans_ctx_check\n    raise exc.InvalidRequestError(\n", "sqlalchemy.exc.InvalidRequestError: Can't operate on closed transaction inside context manager.  Please complete the context manager before emitting further commands.\n"]}}
{"timestamp": "2025-01-02T05:35:15.833702", "level": "DEBUG", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "create_token", "line": 316, "message": "Creating token"}
{"timestamp": "2025-01-02T05:35:15.923870", "level": "DEBUG", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "create_token", "line": 316, "message": "Creating token"}
{"timestamp": "2025-01-02T05:35:15.927328", "level": "INFO", "logger": "SchoolAttendanceLogger", "module": "auth_service", "function": "authenticate_user", "line": 531, "message": "Authentication successful", "user_id": "1"}
